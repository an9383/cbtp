<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  	
<mapper namespace="mes.mappers.mt.equipDataMapper">

	<resultMap id="EquipDataVo" type="mes.domain.mt.EquipDataVo">
		<result property="no"					column="NO"					/>
		<result property="workOrdNo"			column="WORK_ORD_NO"		/>
		<result property="itemSeq"				column="ITEM_SEQ"			/>
		<result property="equipCd"				column="EQUIP_CD"			/>
		<result property="equipNm"				column="EQUIP_NM"			/>
		<result property="recipeNo"				column="RECIPE_NO"			/>
		<result property="stageNo"				column="STAGE_NO"			/>
		<result property="xAxis"				column="X_AXIS"				/>
		<result property="yAxis"				column="Y_AXIS"				/>
		<result property="zAxis"				column="Z_AXIS"				/>
		<result property="sizeX"				column="SIZE_X"				/>
		<result property="sizeY"				column="SIZE_Y"				/>
		<result property="workStatus"			column="WORK_STATUS"		/>
		<result property="workStatusPrev"		column="WORK_STATUS_PREV"	/>
		<result property="workStatusPrev2"		column="WORK_STATUS_PREV2"	/>
		<result property="itemNm"				column="ITEM_NM"			/>
		<result property="processTime"			column="PROCESS_TIME"		/>
		<result property="hallCount"			column="HALL_COUNT"			/>
		<result property="searchDate"			column="SEARCH_DATE"		/>
		<result property="holdTime"				column="HOLD_TIME"			/>
		<result property="operationTime"		column="OPERATION_TIME"		/>
		<result property="productionQty"		column="PRODUCTION_QTY"		/>
		<result property="planQty"				column="PLAN_QTY"			/>
		<result property="faultyQty"			column="FAULTY_QTY"			/>
		<result property="faultyCd"				column="FAULTY_CD"			/>
		<result property="faultyNm"				column="FAULTY_NM"			/>
		<result property="dtlOrdCnt"			column="DTL_ORD_CNT"		/>
		<result property="capOutputCount"		column="capOutputCount"		/>
		<result property="workEndDate"			column="workEndDate"		/>
		<result property="equipCapa"			column="EQUIP_CAPA"			/>
		<result property="dayCount"				column="DAY_COUNT"			/>
		<result property="inputQty"				column="INPUT_QTY"			/>
		<result property="theoryCt"				column="THEORY_CT"			/>
		<result property="loadTime"				column="LOAD_TIME"			/>
		<result property="recipeGb"				column="RECIPE_GB"			/>
		<result property="processStatus"		column="ProcessStatus"		/>
		<result property="nowWorkStatus"		column="NOW_WORK_STATUS"	/>
		<result property="nowCheckStatus"		column="NOW_CHECK_STATUS"	/>
		<result property="woaCheckStatus"		column="WOA_CHECK_STATUS"	/>
		<result property="startDatetime"		column="START_DATETIME"		/>
		<result property="endDatetime"			column="END_DATETIME"		/>
		<result property="workCnt"				column="WORK_CNT"			/>
		<result property="prcNm"				column="PRC_NM"				/>
	</resultMap>
	
	<!-- 가공중인 LASER 설비 가공데이터 조회 -->
	<select id="laserOperInfoLstByEquipCd" resultMap="EquipDataVo">
		SELECT
			ROW_NUMBER() OVER(ORDER BY (SELECT 1)) NO,
			WOA.WORK_ORD_NO,
			WOA.ITEM_SEQ,
			WOA.EQUIP_CD,
			LS.RECIPE_NO,
			LS.STAGE_NO,
			LS.X_AXIS,
			LS.Y_AXIS,
			LS.Z_AXIS,
			LR.RECIPE_GB,
			LR.SCAN_FIELD_DATA_SIZE_X SIZE_X,
			LR.SCAN_FIELD_DATA_SIZE_Y SIZE_Y,
			LOI2.WorkStatus WORK_STATUS,
			LAG(LOI2.WorkStatus, 1)
				OVER(PARTITION BY WOA.WORK_ORD_NO 
						ORDER BY
							LS.RECIPE_NO ASC,
							LS.STAGE_NO ASC) AS WORK_STATUS_PREV,
			LAG(LOI2.WorkStatus, 2)
				OVER(PARTITION BY WOA.WORK_ORD_NO 
						ORDER BY
							LS.RECIPE_NO ASC,
							LS.STAGE_NO ASC) AS WORK_STATUS_PREV2,
			IIA.ITEM_NM,
			IIA.PROCESS_TIME,
			IIA.HALL_COUNT,
			LOI.ProcessStatus,
			LOI.WorkStatus NOW_WORK_STATUS,
			LOI.CheckStatus NOW_CHECK_STATUS,
			WOA.CHECK_STATUS WOA_CHECK_STATUS
		FROM (SELECT
				T1.WorkOrdNo,
				CASE WHEN T1.MES_WorkOrdNo = 'S'
							THEN (SELECT AA.WORK_ORD_NO
								FROM (
								   SELECT  TOP 1 A.WORK_ORD_NO
								   FROM TB_WORK_ORDER_ADM A,
								      TB_ITEM_INFO_ADM B
								   WHERE A.WORK_STATUS IS NULL
								   AND A.ITEM_SEQ = B.ITEM_SEQ
								   AND B.MAIN_GUBUN = '001'
								   AND CONVERT(CHAR(8), A.REG_DATE, 112) = CONVERT(CHAR(8), GETDATE(), 112)
								   ORDER BY WORK_ORD_NO ASC
								) AA)
					 ELSE T1.MES_WorkOrdNo
				END MES_WorkOrdNo,
				T1.ProcessStatus,
				T1.WorkStatus,
				T1.CheckStatus
			FROM TB_LASER_OPER_INFO T1,
				(SELECT
					WorkOrdNo,
					MAX(RegDate) RegDate
				FROM TB_LASER_OPER_INFO
				WHERE 1=1
				AND MES_WorkOrdNo = 'S'
				GROUP BY
					WorkOrdNo) T2
			WHERE 1=1
			AND T1.WorkOrdNo = T2.WorkOrdNo
			AND T1.RegDate = T2.RegDate) LOI,
			TB_WORK_ORDER_ADM WOA
			LEFT OUTER JOIN TB_ITEM_INFO_ADM IIA
			ON 1=1
			AND WOA.ITEM_SEQ = IIA.ITEM_SEQ
			LEFT OUTER JOIN TB_EQUIP_CODE_ADM ECA
			ON 1=1
			AND WOA.EQUIP_CD = ECA.EQUIP_CD
			LEFT OUTER JOIN TB_LASER_STAGE LS
			ON 1=1
			AND IIA.LASER_WORK_NO = LS.WORK_ORD_NO
			LEFT OUTER JOIN (SELECT
								*
							FROM (SELECT
								WORK_ORD_NO,
								RECIPE_NO,
								RECIPE_GB,
								RECIPE_ID,
								CONVERT(FLOAT,RECIPE_VAL1) RECIPE_VAL1
							FROM TB_LASER_RECIPE
							WHERE 1=1
							AND RECIPE_ID LIKE '%SCAN_FIELD_DATA_SIZE%') RESULT
							PIVOT (
								SUM(RECIPE_VAL1) FOR RECIPE_ID IN ([SCAN_FIELD_DATA_SIZE_X], [SCAN_FIELD_DATA_SIZE_Y])
							) T) LR
			ON 1=1
			AND LS.WORK_ORD_NO = LR.WORK_ORD_NO
			AND LS.RECIPE_NO = LR.RECIPE_NO
			LEFT OUTER JOIN (SELECT
								WorkOrdNo,
								WorkRecipeNo,
								WorkStageNo,
								MIN(WorkStatus) WorkStatus
							FROM TB_LASER_OPER_INFO
							WHERE 1=1
							AND MES_WorkOrdNo = 'S'
							GROUP BY
								WorkOrdNo,
								WorkRecipeNo,
								WorkStageNo) LOI2
			ON 1=1
			AND LS.WORK_ORD_NO = LOI2.WorkOrdNo
			AND LS.RECIPE_NO = LOI2.WorkRecipeNo
			AND LS.STAGE_NO = LOI2.WorkStageNo
		WHERE 1=1
		AND LOI.MES_WorkOrdNo = WOA.WORK_ORD_NO
		ORDER BY
			LS.RECIPE_NO ASC,
			LS.STAGE_NO ASC
	</select>
	
	<!-- 기간별 LASER 설비 실적조회 -->
	<select id="laserOperInfoCntByDate" resultMap="EquipDataVo">
		<![CDATA[
			SELECT
				ECA.EQUIP_CD,
				COUNT(WOA.EQUIP_CD) WORK_CNT
			FROM TB_EQUIP_CODE_ADM ECA
				LEFT OUTER JOIN (SELECT
									WOA.WORK_ORD_NO,
									WOA.EQUIP_CD
								FROM TB_WORK_ORDER_ADM WOA
								WHERE 1=1
								AND CONVERT(CHAR(10), WOA.WORK_END_DATE, 23) = CONVERT(CHAR(10), #{endDatetime}, 23)
								GROUP BY
									WOA.WORK_ORD_NO,
									WOA.EQUIP_CD) WOA
				ON 1=1
				AND ECA.EQUIP_CD = WOA.EQUIP_CD
			WHERE 1=1
			AND ECA.MAIN_GUBUN = '001'
			AND ECA.PRC_NM = #{prcNm}
			GROUP BY
				ECA.EQUIP_CD
		]]>
	</select>
	
	<!-- 기간별 후가공 설비 실적조회 -->
	<select id="finishOperInfoCntByDate" resultMap="EquipDataVo">
		<![CDATA[
			SELECT
				ECA.EQUIP_CD,
				COUNT(WOA.EQUIP_CD) WORK_CNT
			FROM TB_EQUIP_CODE_ADM ECA
				LEFT OUTER JOIN (SELECT
									LOI.WorkOrdNo,
									WOA.EQUIP_CD
								FROM TB_LASER_OPER_INFO LOI
									LEFT OUTER JOIN TB_WORK_ORDER_ADM WOA
									ON 1=1
									AND LOI.WorkOrdNo = WOA.WORK_ORD_NO
								WHERE 1=1
								AND LOI.RegDate BETWEEN #{startDatetime} AND #{endDatetime}
								GROUP BY
									LOI.WorkOrdNo,
									WOA.EQUIP_CD) WOA
				ON 1=1
				AND ECA.EQUIP_CD = WOA.EQUIP_CD
			WHERE 1=1
			AND ECA.MAIN_GUBUN = '001'
			AND ECA.PRC_NM = #{prcNm}
			GROUP BY
				ECA.EQUIP_CD
		]]>
	</select>
	
	
		<!-- LASER 설비 가동/비가동 조회 -->
	<select id="laserOperNonOperInfoLstByEquipCd" resultMap="EquipDataVo">
		SELECT 
			A.EQUIP_CD,
			ISNULL(B.DAY_PRODUCTION_QTY, 0) PRODUCTION_QTY,
			ISNULL(C.PLAN_QTY, 0) PLAN_QTY,
			(CASE workEndDate WHEN '' THEN 'S'
				ELSE 'E'
				END
			) AS WORK_STATUS,
			D.WorkOrdNo AS WORK_ORD_NO,
			D.ITEM_NM
		FROM TB_EQUIP_CODE_ADM A LEFT JOIN (
		SELECT COUNT(WorkOrdNo) DAY_PRODUCTION_QTY, EQUIP_CD
					FROM (
						SELECT X.WorkOrdNo, B.EQUIP_CD
						FROM TB_LASER_OPER_INFO X, TB_WORK_ORDER_ADM B, TB_EQUIP_CODE_ADM C
						WHERE X.WorkOrdNo = B.WORK_ORD_NO AND B.EQUIP_CD = C.EQUIP_CD 
						AND C.PRC_NM = '001' AND C.USE_YN = '001'
						GROUP BY WorkOrdNo, B.EQUIP_CD
						HAVING CONVERT(CHAR(8), MIN(REGDATE), 112)  LIKE CONVERT(CHAR(8), GETDATE(), 112)
					) A
					GROUP BY EQUIP_CD
		) B ON A.EQUIP_CD = B.EQUIP_CD LEFT JOIN (
			SELECT SUM(PLAN_QTY) PLAN_QTY, PLAN_EQUIP_CD
			FROM (
			SELECT DISTINCT 
			CONT_DTL_NO
			FROM TB_WORK_ORDER_ADM WHERE 
			WORK_START_DATE LIKE CONCAT(LEFT(CONVERT(CHAR(8), GETDATE(), 112), 4), '-', RIGHT(CONVERT(CHAR(8), GETDATE(), 112), 2), '%')	
			) A, TB_ADV_PLAN_SCHEDULE  B
			WHERE A.CONT_DTL_NO = B.CONT_DTL_NO
			GROUP BY PLAN_EQUIP_CD
		) C ON A.EQUIP_CD = C.PLAN_EQUIP_CD LEFT JOIN (
			SELECT
				workOrdNo,
				MAX(workEndDate) workEndDate,
				B.EQUIP_CD,
				C.ITEM_NM
			FROM TB_LASER_OPER_INFO A, TB_WORK_ORDER_ADM B, TB_ITEM_INFO_ADM C
			WHERE A.WorkOrdNo = B.WORK_ORD_NO AND B.ITEM_SEQ = C.ITEM_SEQ
			GROUP BY WorkOrdNo, EQUIP_CD, ITEM_NM
		    HAVING MAX(workEndDate) = ''
		) D ON A.EQUIP_CD = D.EQUIP_CD
		WHERE PRC_NM = '001'
		AND MAIN_GUBUN = '001'
	</select>
	
	<!-- 가공중인 후가공 설비 가공데이터 조회 -->
	<select id="finishOperInfoLstByEquipCd" resultMap="EquipDataVo">
		SELECT
			ROW_NUMBER() OVER(ORDER BY (SELECT 1)) NO,
			WOA.WORK_ORD_NO,
			WOA.ITEM_SEQ,
			WOA.EQUIP_CD,
			IIA.ITEM_NM,
			IIA.PROCESS_TIME,
			IIA.HALL_COUNT,
			BOD.DTL_ORD_CNT,
			LOI.capOutputCount,
			LOI.workEndDate,
			WOA.WORK_STATUS
		FROM (SELECT
				A.workOrdNo,
				B.WORK_END_DATE workEndDate,
				A.capOutputCount,
				A.REGDATE,
				A.CapOperStatus
				FROM TB_FINISH_OPER_INFO A, TB_WORK_ORDER_ADM B
				WHERE A.WorkOrdNo = B.WORK_ORD_NO
				AND A.REGDATE = (SELECT MAX(X.REGDATE)
					FROM TB_FINISH_OPER_INFO X
					WHERE EQUIPCD = B.Equip_Cd
					GROUP BY EQUIPCD)
				) LOI LEFT JOIN	TB_WORK_ORDER_ADM WOA
			ON LOI.WorkOrdNo = WOA.WORK_ORD_NO 
			LEFT OUTER JOIN TB_EQUIP_CODE_ADM ECA
			ON 1=1
			AND WOA.EQUIP_CD = ECA.EQUIP_CD
			LEFT OUTER JOIN TB_ITEM_INFO_ADM IIA
			ON 1=1
			AND WOA.ITEM_SEQ = IIA.ITEM_SEQ
			LEFT JOIN TB_BIZ_ORDER_DTL BOD
			ON 1=1
			AND WOA.CONT_DTL_NO = BOD.CONT_DTL_NO
		WHERE 1=1
		AND MAIN_GUBUN = '001'
	</select>
	
	<!-- 가공중인 LASER 설비 가공데이터 조회 -->
	<select id="laserOperInfoLstByWorkOrdNo" resultMap="EquipDataVo">
		SELECT
			ROW_NUMBER() OVER(ORDER BY (SELECT 1)) NO,
			WOA.WORK_ORD_NO,
			WOA.ITEM_SEQ,
			WOA.EQUIP_CD,
			LS.RECIPE_NO,
			LS.STAGE_NO,
			LS.X_AXIS,
			LS.Y_AXIS,
			LS.Z_AXIS,
			LR.RCP_INFO_TGT_SIZE_X SIZE_X,
			LR.RCP_INFO_TGT_SIZE_Y SIZE_Y,
			LOI2.WorkStatus WORK_STATUS,
			LAG(LOI2.WorkStatus, 1)
				OVER(PARTITION BY WOA.WORK_ORD_NO 
						ORDER BY
							LS.RECIPE_NO ASC,
							LS.STAGE_NO ASC) AS WORK_STATUS_PREV,
			LAG(LOI2.WorkStatus, 2)
				OVER(PARTITION BY WOA.WORK_ORD_NO 
						ORDER BY
							LS.RECIPE_NO ASC,
							LS.STAGE_NO ASC) AS WORK_STATUS_PREV2,
			IIA.ITEM_NM,
			IIA.PROCESS_TIME,
			IIA.HALL_COUNT
		FROM TB_WORK_ORDER_ADM WOA
			LEFT OUTER JOIN TB_EQUIP_CODE_ADM ECA
			ON 1=1
			AND WOA.EQUIP_CD = ECA.EQUIP_CD
			LEFT OUTER JOIN TB_LASER_STAGE LS
			ON 1=1
			AND WOA.WORK_ORD_NO = LS.WORK_ORD_NO
			LEFT OUTER JOIN (SELECT
								*
							FROM (SELECT
								WORK_ORD_NO,
								RECIPE_NO,
								RECIPE_ID,
								CONVERT(FLOAT,RECIPE_VAL1) RECIPE_VAL1
							FROM TB_LASER_RECIPE
							WHERE 1=1
							AND RECIPE_ID LIKE '%RCP_INFO_TGT_SIZE%') RESULT
							PIVOT (
								SUM(RECIPE_VAL1) FOR RECIPE_ID IN ([RCP_INFO_TGT_SIZE_X], [RCP_INFO_TGT_SIZE_Y])
							) T) LR
			ON 1=1
			AND LS.WORK_ORD_NO = LR.WORK_ORD_NO
			AND LS.RECIPE_NO = LR.RECIPE_NO
			LEFT OUTER JOIN (SELECT
								WorkOrdNo,
								WorkRecipeNo,
								WorkStageNo,
								MAX(WorkStatus) WorkStatus
							FROM TB_LASER_OPER_INFO
							WHERE 1=1
							AND WorkRecipeNo != ''
							GROUP BY
								WorkOrdNo,
								WorkRecipeNo,
								WorkStageNo) LOI2
			ON 1=1
			AND WOA.WORK_ORD_NO = LOI2.WorkOrdNo
			AND LS.RECIPE_NO = LOI2.WorkRecipeNo
			AND LS.STAGE_NO = LOI2.WorkStageNo
			LEFT OUTER JOIN TB_ITEM_INFO_ADM IIA
			ON 1=1
			AND WOA.ITEM_SEQ = IIA.ITEM_SEQ
		WHERE 1=1
		AND WOA.WORK_ORD_NO = #{workOrdNo}
		ORDER BY
			RECIPE_NO ASC,
			STAGE_NO ASC
	</select>
	
	<!-- 시간가동율 분자 -->
	<select id="timeOperationPercentDenominator" resultType="double">
		<if test="mainGubun.equals('001')">
			SELECT 
			ISNULL(SUM((
				CASE WHEN A.WORK_END_DATE IS NULL
				THEN DATEDIFF(MS, WORK_START_DATE, GETDATE())
				ELSE DATEDIFF(MS, A.WORK_START_DATE, A.WORK_END_DATE)
				END
			)), 0) 
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
			AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
			AND A.EQUIP_CD = #{equipCd}
			</if>
			<if test="dateType.equals('month')">
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
			</if>
		</if>
		<if test="mainGubun.equals('002')">
			SELECT 
			ISNULL(SUM((
				CASE WHEN A.WORK_END_DATE IS NULL
				THEN DATEDIFF(MS, WORK_START_DATE, WORK_START_DATE)
				ELSE DATEDIFF(MS, A.WORK_START_DATE, A.WORK_END_DATE)
				END
			)), 0) 
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
			AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
			AND A.EQUIP_CD = #{equipCd}
			</if>
			<if test="dateType.equals('month')">
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
			</if>
			<!-- 
			SELECT ISNULL(SUM(A.WORK_TIME), 0)
			FROM (
				SELECT 
					(
						CASE WHEN A.STATUS = 'START'
						THEN 
						DATEDIFF(MS, A.START_DATE, (
							CASE WHEN LEAD(A.END_DATE) OVER(ORDER BY NUM) IS NOT NULL
							THEN LEAD(A.END_DATE) OVER(ORDER BY NUM)
							ELSE GETDATE()
							END
						))
						ELSE 0
						END
					) WORK_TIME,
					START_DATE,
					LEAD(A.END_DATE) OVER(ORDER BY NUM) END_DATE
			
				FROM (
					SELECT 
						(
							CASE WHEN A.FillStartSignal = 0 AND A.FillStartSignal = 0 AND A.nextFillStartSignal = 1 AND nextFillStartYn = 1
							THEN A.nextRegDate
							ELSE NULL
							END
						) START_DATE,
						(
							CASE WHEN A.FillStartSignal = 1 AND A.FillStartSignal = 1 AND A.nextFillStartSignal = 0 AND nextFillStartYn = 0
							THEN A.nextRegDate
							ELSE NULL
							END
						) END_DATE,
						(
							CASE WHEN A.FillStartSignal = 0 AND A.FillStartSignal = 0 AND A.nextFillStartSignal = 1 AND nextFillStartYn = 1
							THEN 'START'
							WHEN A.FillStartSignal = 1 AND A.FillStartSignal = 1 AND A.nextFillStartSignal = 0 AND nextFillStartYn = 0
							THEN 'END'
							ELSE NULL
							END
						) STATUS,
						ROW_NUMBER() OVER (ORDER BY (SELECT 1)) AS NUM
					FROM (
						SELECT
						A.FillStartSignal,
						A.FillStartYn,
						A.regDate,
						LEAD(A.FillStartSignal) OVER(ORDER BY (SELECT 1)) AS nextFillStartSignal,
						LEAD(A.FillStartYn) OVER(ORDER BY (SELECT 1)) AS nextFillStartYn,
						LEAD(A.RegDate) OVER(ORDER BY (SELECT 1)) AS nextRegDate
						FROM TB_PACKING_OPER_INFO A
						<if test="dateType.equals('month')">
						WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(#{searchDate}, '%')		
						</if>
						<if test="dateType.equals('year')">
						WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
						</if>
					) A
					WHERE (
							CASE WHEN A.FillStartSignal = 0 AND A.FillStartSignal = 0 AND A.nextFillStartSignal = 1 AND nextFillStartYn = 1
							THEN A.nextRegDate
							ELSE NULL
							END
						) IS NOT NULL OR (
							CASE WHEN A.FillStartSignal = 1 AND A.FillStartSignal = 1 AND A.nextFillStartSignal = 0 AND nextFillStartYn = 0
							THEN A.nextRegDate
							ELSE NULL
							END
						) IS NOT NULL
				) A
			) A
			 -->
		</if>
		<!-- 
		<if test="mainGubun.equals('001')">
			SELECT ISNULL(SUM(WorkExpectTime), 0) 
			FROM TB_LASER_OPER_INFO A, TB_WORK_ORDER_ADM B , TB_EQUIP_CODE_ADM C
			WHERE A.WorkOrdNo = B.WORK_ORD_NO
			AND B.EQUIP_CD = C.EQUIP_CD
			AND C.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
			AND B.EQUIP_CD = #{equipCd}
			</if>
			<if test="dateType.equals('month')">
			AND WorkStartDate LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')		
			</if>
			<if test="dateType.equals('year')">
			AND WorkStartDate LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
			</if>
		</if>
		<if test="mainGubun.equals('002')">
			SELECT ISNULL(SUM((
				CASE WHEN B.WORK_END_DATE IS NULL
				THEN DATEDIFF(MS, WORK_START_DATE, GETDATE())
				ELSE DATEDIFF(MS, B.WORK_START_DATE, B.WORK_END_DATE)
				END
			)), 0) 
			FROM TB_FINISH_OPER_INFO A, TB_WORK_ORDER_ADM B , TB_EQUIP_CODE_ADM C
			WHERE A.WorkOrdNo = B.WORK_ORD_NO 
			AND B.EQUIP_CD = C.EQUIP_CD
			AND C.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
			AND B.EQUIP_CD = #{equipCd}
			</if>
			<if test="dateType.equals('month')">
			AND B.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
			AND B.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
			</if>
		</if>
		 -->
	</select>
	
	<!-- 시간가동율 분모 -->
	<select id="timeOperationPercentMolecule" resultType="double">
		SELECT 
		<if test="mainGubun.equals('001')">
			<if test="equipCd !=null and !equipCd.equals('')">
			ISNULL(CONVERT(float, SUM(RUNNING_TIME)), 0) * 3600000
			</if>
			<if test="equipCd ==null or equipCd.equals('')">
			ISNULL(CONVERT(float, SUM(RUNNING_TIME)), 0) * 3600000 *
			(SELECT COUNT(*) FROM TB_EQUIP_CODE_ADM 
			WHERE PRC_NM = #{mainGubun}
			AND USE_YN = '001')
			</if>
		</if>
		<if test="mainGubun.equals('002')">
			ISNULL(CONVERT(float, SUM(RUNNING_TIME)), 0) * 3600000
		</if>
		FROM TB_FACTORY_CALENDAR
		WHERE FACTORY_TYPE = #{mainGubun}
		<if test="dateType.equals('month')">
		AND FACTORY_DATE LIKE CONCAT('%', #{searchDate}, '%')
		</if>
		<if test="dateType.equals('year')">
		AND FACTORY_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
		</if>
	</select>
	
	<!-- 양품율 분자(불량수량) = 분모(투입수량)-분자(불량수량) -->
	<select id="fairQtyPercentDenominator" resultType="double">
		<if test="mainGubun.equals('001')">
			SELECT ISNULL(SUM(FAULTY_QTY), 0)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.USE_YN = '001'
				AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
				AND B.EQUIP_CD = #{equipCd}
			</if>	
			<if test="dateType.equals('month')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
			</if>
		</if>
		<if test="mainGubun.equals('002')">
			SELECT ISNULL(SUM(FAULTY_QTY), 0)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.USE_YN = '001'
				AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
				AND B.EQUIP_CD = #{equipCd}
			</if>	
			<if test="dateType.equals('month')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
			</if>
			<!-- 
			SELECT
				ISNULL(SUM((END_COUNT1+END_COUNT2+END_COUNT3) - (START_COUNT1+START_COUNT2+START_COUNT3)), 0)
			FROM (
				SELECT DISTINCT
					(SELECT TOP 1 X.WchkUnderCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT1,
					ISNULL((
						SELECT TOP 1 Y.WchkUnderCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
						AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
						), (
						SELECT TOP 1 Y.WchkUnderCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.RegDate > A.RegDate
						ORDER BY RegDate DESC
						)) END_COUNT1,
					(SELECT TOP 1 X.WchkOverCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT2,
					ISNULL((
						SELECT TOP 1 Y.WchkOverCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
						AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
						), (
						SELECT TOP 1 Y.WchkOverCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.RegDate > A.RegDate
						ORDER BY RegDate DESC
						)) END_COUNT2,
					(SELECT TOP 1 X.WchkExNgCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT3,
					ISNULL((
						SELECT TOP 1 Y.WchkExNgCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
						AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
						), (
						SELECT TOP 1 Y.WchkExNgCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.RegDate > A.RegDate
						ORDER BY RegDate DESC
						)) END_COUNT3
				FROM TB_PACKING_OPER_INFO A
				WHERE FillStartSignal = 0 AND FillStartYn = 0
			<if test="dateType.equals('month')">
				AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(#{searchDate}, '%')
			</if>
			<if test="dateType.equals('year')">
				AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
			</if>
			) A
			 -->
		</if>
	</select>
	
	<!-- 양품율 분모(투입수량) -->
	<select id="fairQtyPercentMolecule" resultType="double">
		<if test="mainGubun.equals('001')">
			SELECT COUNT(*)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.USE_YN = '001'
				AND B.PRC_NM = #{mainGubun}
				AND A.WORK_END_DATE IS NOT NULL
			<if test="equipCd !=null and !equipCd.equals('')">
				AND B.EQUIP_CD = #{equipCd}
			</if>	
			<if test="dateType.equals('month')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
			</if>
		</if>
		<if test="mainGubun.equals('002')">
			SELECT ISNULL(SUM(OUTPUT_QTY), 0)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.USE_YN = '001'
				AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
				AND B.EQUIP_CD = #{equipCd}
			</if>	
			<if test="dateType.equals('month')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
			</if>
			<!-- 
			SELECT
				ISNULL(SUM(END_COUNT - START_COUNT), 0)
			FROM (
				SELECT DISTINCT
					(SELECT TOP 1 X.FillOutputCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT,
					ISNULL((
						SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
						AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
						), (
						SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.RegDate > A.RegDate
						ORDER BY RegDate DESC
						)) END_COUNT,
					ISNULL((
						SELECT TOP 1
						Z.PROCESS_TIME
						FROM (SELECT X.ITEM_SEQ, X.EQUIP_CD
						FROM TB_WORK_ORDER_ADM X
						WHERE CONVERT(CHAR(8), X.REG_DATE, 112) = CONVERT(CHAR(8), (SELECT TOP 1 B.RegDate FROM TB_PACKING_OPER_INFO B WHERE B.FillStartSignal = 1 AND B.FillStartYn = 1 AND B.RegDate > A.RegDate), 112)
						) X, TB_EQUIP_CODE_ADM Y, TB_ITEM_INFO_ADM Z
						WHERE X.EQUIP_CD = Y.EQUIP_CD
							AND Y.PRC_NM = '002'
							AND X.ITEM_SEQ = Z.ITEM_SEQ
					), 0) * 1000 AS PROCESS_TIME,
					ISNULL((
						SELECT TOP 1
						Z.READY_TIME
						FROM (SELECT X.ITEM_SEQ, X.EQUIP_CD
						FROM TB_WORK_ORDER_ADM X
						WHERE CONVERT(CHAR(8), X.REG_DATE, 112) = CONVERT(CHAR(8), (SELECT TOP 1 B.RegDate FROM TB_PACKING_OPER_INFO B WHERE B.FillStartSignal = 1 AND B.FillStartYn = 1 AND B.RegDate > A.RegDate), 112)
						) X, TB_EQUIP_CODE_ADM Y, TB_ITEM_INFO_ADM Z
						WHERE X.EQUIP_CD = Y.EQUIP_CD
							AND Y.PRC_NM = '002'
							AND X.ITEM_SEQ = Z.ITEM_SEQ
					), 0) * 60000 AS READY_TIME
				FROM TB_PACKING_OPER_INFO A
				WHERE FillStartSignal = 0 AND FillStartYn = 0
				<if test="dateType.equals('month')">
				AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(#{searchDate}, '%')		
				</if>
				<if test="dateType.equals('year')">
				AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
				</if>
			) A
			 -->
		</if>
		<!-- 
		<if test="mainGubun.equals('001')">
			SELECT COUNT(WorkOrdNo)
			FROM (
				SELECT X.WorkOrdNo, (SELECT Y.EQUIP_CD FROM TB_WORK_ORDER_ADM Y WHERE Y.WORK_ORD_NO = X.workOrdNo) EQUIP_CD
				FROM TB_LASER_OPER_INFO X
				GROUP BY WorkOrdNo
				<if test="dateType.equals('month')">
				HAVING CONVERT(CHAR(8), MIN(REGDATE), 112)  LIKE CONCAT(LEFT(#{searchDate}, 4), RIGHT(#{searchDate}, 2), '%')
				</if>
				<if test="dateType.equals('year')">
				HAVING CONVERT(CHAR(8), MIN(REGDATE), 112) LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
				</if>
			) A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
			AND B.USE_YN = '001'
			AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
			AND B.EQUIP_CD = #{equipCd}
			</if>
		</if>
		<if test="mainGubun.equals('002')">
			SELECT ISNULL(SUM(OUTPUT_QTY), 0)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.USE_YN = '001'
				AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
				AND B.EQUIP_CD = #{equipCd}
			</if>	
			<if test="dateType.equals('month')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
			</if>
		</if>
		 -->
	</select>
	
	<!-- 성능가동율 분모 -->
	<select id="performanceOperationPercentMolecule" resultType="double">
		<if test="mainGubun.equals('001')">
			SELECT 
			ISNULL(SUM((
				CASE WHEN A.WORK_END_DATE IS NULL
				THEN DATEDIFF(MS, WORK_START_DATE, GETDATE())
				ELSE DATEDIFF(MS, A.WORK_START_DATE, A.WORK_END_DATE)
				END
			)), 0) 
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
			AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
			AND A.EQUIP_CD = #{equipCd}
			</if>
			<if test="dateType.equals('month')">
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
			</if>
		</if>
		<if test="mainGubun.equals('002')">
			SELECT 
			ISNULL(SUM((
				CASE WHEN A.WORK_END_DATE IS NULL
				THEN DATEDIFF(MS, A.WORK_START_DATE, A.WORK_START_DATE)
				ELSE DATEDIFF(MS, A.WORK_START_DATE, A.WORK_END_DATE)
				END
			)), 0) 
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
			AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
			AND A.EQUIP_CD = #{equipCd}
			</if>
			<if test="dateType.equals('month')">
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
			</if>
		</if>
		<!-- 
		<if test="mainGubun.equals('001')">
			SELECT 
			ISNULL(SUM((
				CASE WHEN A.WORK_END_DATE IS NULL
				THEN DATEDIFF(MS, WORK_START_DATE, GETDATE())
				ELSE DATEDIFF(MS, A.WORK_START_DATE, A.WORK_END_DATE)
				END
			)), 0) 
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
			AND A.WORK_END_DATE IS NOT NULL
			AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
			AND A.EQUIP_CD = #{equipCd}
			</if>
			<if test="dateType.equals('month')">
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
			</if>
		</if>
		<if test="mainGubun.equals('002')">
			SELECT ISNULL(SUM(A.WORK_TIME), 0)
			FROM (
				SELECT 
					(
						CASE WHEN A.STATUS = 'START'
						THEN 
						DATEDIFF(MS, A.START_DATE, (
							CASE WHEN LEAD(A.END_DATE) OVER(ORDER BY NUM) IS NOT NULL
							THEN LEAD(A.END_DATE) OVER(ORDER BY NUM)
							ELSE GETDATE()
							END
						))
						ELSE 0
						END
					) WORK_TIME,
					START_DATE,
					LEAD(A.END_DATE) OVER(ORDER BY NUM) END_DATE
			
				FROM (
					SELECT 
						(
							CASE WHEN A.FillStartSignal = 0 AND A.FillStartSignal = 0 AND A.nextFillStartSignal = 1 AND nextFillStartYn = 1
							THEN A.nextRegDate
							ELSE NULL
							END
						) START_DATE,
						(
							CASE WHEN A.FillStartSignal = 1 AND A.FillStartSignal = 1 AND A.nextFillStartSignal = 0 AND nextFillStartYn = 0
							THEN A.nextRegDate
							ELSE NULL
							END
						) END_DATE,
						(
							CASE WHEN A.FillStartSignal = 0 AND A.FillStartSignal = 0 AND A.nextFillStartSignal = 1 AND nextFillStartYn = 1
							THEN 'START'
							WHEN A.FillStartSignal = 1 AND A.FillStartSignal = 1 AND A.nextFillStartSignal = 0 AND nextFillStartYn = 0
							THEN 'END'
							ELSE NULL
							END
						) STATUS,
						ROW_NUMBER() OVER (ORDER BY (SELECT 1)) AS NUM
					FROM (
						SELECT
						A.FillStartSignal,
						A.FillStartYn,
						A.regDate,
						LEAD(A.FillStartSignal) OVER(ORDER BY (SELECT 1)) AS nextFillStartSignal,
						LEAD(A.FillStartYn) OVER(ORDER BY (SELECT 1)) AS nextFillStartYn,
						LEAD(A.RegDate) OVER(ORDER BY (SELECT 1)) AS nextRegDate
						FROM TB_PACKING_OPER_INFO A
						<if test="dateType.equals('month')">
						WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(#{searchDate}, '%')		
						</if>
						<if test="dateType.equals('year')">
						WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
						</if>
					) A
					WHERE (
							CASE WHEN A.FillStartSignal = 0 AND A.FillStartSignal = 0 AND A.nextFillStartSignal = 1 AND nextFillStartYn = 1
							THEN A.nextRegDate
							ELSE NULL
							END
						) IS NOT NULL OR (
							CASE WHEN A.FillStartSignal = 1 AND A.FillStartSignal = 1 AND A.nextFillStartSignal = 0 AND nextFillStartYn = 0
							THEN A.nextRegDate
							ELSE NULL
							END
						) IS NOT NULL
				) A
			) A
		</if>
		 -->
		<!-- 
		<if test="mainGubun.equals('001')">
			SELECT ISNULL(SUM(WorkExpectTime), 0) 
			FROM TB_LASER_OPER_INFO A, TB_WORK_ORDER_ADM B , TB_EQUIP_CODE_ADM C
			WHERE A.WorkOrdNo = B.WORK_ORD_NO 
			AND B.EQUIP_CD = C.EQUIP_CD
			AND C.USE_YN = '001'
			AND C.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
			AND B.EQUIP_CD = #{equipCd}
			</if>
			<if test="dateType.equals('month')">
			AND WorkStartDate LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')		
			</if>
			<if test="dateType.equals('year')">
			AND WorkStartDate LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
			</if>
		</if>
		<if test="mainGubun.equals('002')">
		 	SELECT ISNULL (SUM(EQUIP_CAPA), 0)
		 	FROM TB_EQUIP_CODE_ADM
		 	WHERE PRC_NM = #{mainGubun}
		 	AND MAIN_GUBUN = '001'
		 	AND USE_YN = '001'
		 	<if test="equipCd !=null and !equipCd.equals('')">
			AND EQUIP_CD = #{equipCd}
			</if>
		</if>
		 -->
	</select>
	
	<!-- 성능가동율 분자 -->
	<select id="performanceOperationPercentDenominator" resultType="double">
		<if test="mainGubun.equals('001')">
			SELECT
				ISNULL(SUM(
				ISNULL(ISNULL(READY_TIME, 0) + ISNULL(PROCESS_TIME, 0) *QTY, 0) * 60000
				), 0)
			FROM (
				SELECT
				COUNT(WORK_ORD_NO) QTY, READY_TIME, PROCESS_TIME
				FROM (
					SELECT 
						A.WORK_ORD_NO,
						(SELECT Y.ITEM_SEQ FROM TB_WORK_ORDER_ADM Y WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO) ITEM_SEQ,
						(SELECT Z.READY_TIME FROM TB_WORK_ORDER_ADM Y, TB_ITEM_INFO_ADM Z WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO AND Y.ITEM_SEQ = Z.ITEM_SEQ) READY_TIME,
						(SELECT Z.PROCESS_TIME FROM TB_WORK_ORDER_ADM Y, TB_ITEM_INFO_ADM Z WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO AND Y.ITEM_SEQ = Z.ITEM_SEQ) PROCESS_TIME,
						(SELECT Y.EQUIP_CD FROM TB_WORK_ORDER_ADM Y WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO) EQUIP_CD
					FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
					WHERE A.EQUIP_CD = B.EQUIP_CD
						AND B.USE_YN = '001'
						AND B.PRC_NM = '001'
						AND A.WORK_END_DATE IS NOT NULL
						<if test="equipCd !=null and !equipCd.equals('')">
						AND A.EQUIP_CD = #{equipCd}
						</if>
						<if test="dateType.equals('month')">
						AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
						</if>
						<if test="dateType.equals('year')">
						AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
						</if>
				) A
				GROUP BY WORK_ORD_NO, READY_TIME, PROCESS_TIME
			) A
		</if>
		<if test="mainGubun.equals('002')">
			SELECT ISNULL(SUM((C.READY_TIME * 60000) + (A.OUTPUT_QTY * PROCESS_TIME * 1000)), 0)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B, TB_ITEM_INFO_ADM C
			WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.USE_YN = '001'
				AND A.ITEM_SEQ = C.ITEM_SEQ
				AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
				AND B.EQUIP_CD = #{equipCd}
			</if>
			<if test="dateType.equals('month')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
			</if>
			<!-- 
			SELECT
				ISNULL(SUM(READY_TIME + PROCESS_TIME*(END_COUNT - START_COUNT)), 0)
			FROM (
				SELECT DISTINCT
					(SELECT TOP 1 X.FillOutputCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT,
					ISNULL((
						SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
						AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
						), (
						SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.RegDate > A.RegDate
						ORDER BY RegDate DESC
						)) END_COUNT,
					ISNULL((
						SELECT TOP 1
						Z.PROCESS_TIME
						FROM (SELECT X.ITEM_SEQ, X.EQUIP_CD
						FROM TB_WORK_ORDER_ADM X
						WHERE CONVERT(CHAR(8), X.REG_DATE, 112) = CONVERT(CHAR(8), (SELECT TOP 1 B.RegDate FROM TB_PACKING_OPER_INFO B WHERE B.FillStartSignal = 1 AND B.FillStartYn = 1 AND B.RegDate > A.RegDate), 112)
						) X, TB_EQUIP_CODE_ADM Y, TB_ITEM_INFO_ADM Z
						WHERE X.EQUIP_CD = Y.EQUIP_CD
							AND Y.PRC_NM = '002'
							AND X.ITEM_SEQ = Z.ITEM_SEQ
					), 0) * 1000 AS PROCESS_TIME,
					ISNULL((
						SELECT TOP 1
						Z.READY_TIME
						FROM (SELECT X.ITEM_SEQ, X.EQUIP_CD
						FROM TB_WORK_ORDER_ADM X
						WHERE CONVERT(CHAR(8), X.REG_DATE, 112) = CONVERT(CHAR(8), (SELECT TOP 1 B.RegDate FROM TB_PACKING_OPER_INFO B WHERE B.FillStartSignal = 1 AND B.FillStartYn = 1 AND B.RegDate > A.RegDate), 112)
						) X, TB_EQUIP_CODE_ADM Y, TB_ITEM_INFO_ADM Z
						WHERE X.EQUIP_CD = Y.EQUIP_CD
							AND Y.PRC_NM = '002'
							AND X.ITEM_SEQ = Z.ITEM_SEQ
					), 0) * 60000 AS READY_TIME
				FROM TB_PACKING_OPER_INFO A
				WHERE FillStartSignal = 0 AND FillStartYn = 0
				<if test="dateType.equals('month')">
				AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(#{searchDate}, '%')		
				</if>
				<if test="dateType.equals('year')">
				AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
				</if>
			) A
			 -->
		</if>
		<!-- 
		<if test="mainGubun.equals('001')">
		SELECT 
			ISNULL(SUM(
			ISNULL(ISNULL(READY_TIME, 0) + ISNULL(PROCESS_TIME, 0) *QTY, 0) * 60000
			), 0)
		FROM (
			SELECT COND_DTL_MO, COUNT(WorkOrdNo) QTY, READY_TIME, PROCESS_TIME
			FROM (
				SELECT WorkOrdNo,
				(SELECT Y.CONT_DTL_NO FROM TB_WORK_ORDER_ADM Y WHERE Y.WORK_ORD_NO = X.WorkOrdNo) COND_DTL_MO,
				(SELECT Y.ITEM_SEQ FROM TB_WORK_ORDER_ADM Y WHERE Y.WORK_ORD_NO = X.WorkOrdNo) ITEM_SEQ,
				(SELECT Z.READY_TIME FROM TB_WORK_ORDER_ADM Y, TB_ITEM_INFO_ADM Z WHERE Y.WORK_ORD_NO = X.WorkOrdNo AND Y.ITEM_SEQ = Z.ITEM_SEQ) READY_TIME,
				(SELECT Z.PROCESS_TIME FROM TB_WORK_ORDER_ADM Y, TB_ITEM_INFO_ADM Z WHERE Y.WORK_ORD_NO = X.WorkOrdNo AND Y.ITEM_SEQ = Z.ITEM_SEQ) PROCESS_TIME,
				(SELECT Y.EQUIP_CD FROM TB_WORK_ORDER_ADM Y WHERE Y.WORK_ORD_NO = X.WorkOrdNo) EQUIP_CD
				FROM TB_LASER_OPER_INFO X
				GROUP BY WorkOrdNo
				<if test="dateType.equals('month')">
				HAVING CONVERT(CHAR(8), MIN(REGDATE), 112) LIKE CONCAT(LEFT(#{searchDate}, 4), RIGHT(#{searchDate}, 2), '%')
				</if>
				<if test="dateType.equals('year')">
				HAVING CONVERT(CHAR(8), MIN(REGDATE), 112) LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
				</if>
			) A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
			AND B.USE_YN = '001'
			AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
			AND B.EQUIP_CD = #{equipCd}
			</if>
			GROUP BY COND_DTL_MO, READY_TIME, PROCESS_TIME, A.EQUIP_CD
		) B
		</if>
		<if test="mainGubun.equals('002')">
			SELECT ISNULL(SUM(OUTPUT_QTY), 0)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.USE_YN = '001'
				AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
				AND B.EQUIP_CD = #{equipCd}
			</if>	
			<if test="dateType.equals('month')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
			</if>
		</if>
		 -->
	</select>
	
	<!-- 생산량 조회 -->
	<select id="getProductionQty" resultType="double">
		<if test="mainGubun.equals('001')">
			SELECT COUNT(*)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.USE_YN = '001'
				AND B.PRC_NM = #{mainGubun}
				AND A.WORK_END_DATE IS NOT NULL
			<if test="equipCd !=null and !equipCd.equals('')">
				AND B.EQUIP_CD = #{equipCd}
			</if>	
			<if test="dateType.equals('month')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
			</if>
		</if>
		<if test="mainGubun.equals('002')">
			SELECT ISNULL(SUM(OUTPUT_QTY), 0)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.USE_YN = '001'
				AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
				AND B.EQUIP_CD = #{equipCd}
			</if>	
			<if test="dateType.equals('month')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
			</if>
			<!-- 
			SELECT
				ISNULL(SUM(END_COUNT - START_COUNT), 0)
			FROM (
				SELECT DISTINCT
					(SELECT TOP 1 X.FillOutputCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT,
					ISNULL((
						SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
						AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
						), (
						SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.RegDate > A.RegDate
						ORDER BY RegDate DESC
						)) END_COUNT,
					ISNULL((
						SELECT TOP 1
						Z.PROCESS_TIME
						FROM (SELECT X.ITEM_SEQ, X.EQUIP_CD
						FROM TB_WORK_ORDER_ADM X
						WHERE CONVERT(CHAR(8), X.REG_DATE, 112) = CONVERT(CHAR(8), (SELECT TOP 1 B.RegDate FROM TB_PACKING_OPER_INFO B WHERE B.FillStartSignal = 1 AND B.FillStartYn = 1 AND B.RegDate > A.RegDate), 112)
						) X, TB_EQUIP_CODE_ADM Y, TB_ITEM_INFO_ADM Z
						WHERE X.EQUIP_CD = Y.EQUIP_CD
							AND Y.PRC_NM = '002'
							AND X.ITEM_SEQ = Z.ITEM_SEQ
					), 0) * 1000 AS PROCESS_TIME,
					ISNULL((
						SELECT TOP 1
						Z.READY_TIME
						FROM (SELECT X.ITEM_SEQ, X.EQUIP_CD
						FROM TB_WORK_ORDER_ADM X
						WHERE CONVERT(CHAR(8), X.REG_DATE, 112) = CONVERT(CHAR(8), (SELECT TOP 1 B.RegDate FROM TB_PACKING_OPER_INFO B WHERE B.FillStartSignal = 1 AND B.FillStartYn = 1 AND B.RegDate > A.RegDate), 112)
						) X, TB_EQUIP_CODE_ADM Y, TB_ITEM_INFO_ADM Z
						WHERE X.EQUIP_CD = Y.EQUIP_CD
							AND Y.PRC_NM = '002'
							AND X.ITEM_SEQ = Z.ITEM_SEQ
					), 0) * 60000 AS READY_TIME
				FROM TB_PACKING_OPER_INFO A
				WHERE FillStartSignal = 0 AND FillStartYn = 0
				<if test="dateType.equals('month')">
				AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(#{searchDate}, '%')		
				</if>
				<if test="dateType.equals('year')">
				AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
				</if>
			) A
			 -->
		</if>
	<!-- 
	<if test="mainGubun.equals('001')">
		SELECT ISNULL(SUM(QTY), 0)
		FROM (
			SELECT COND_DTL_MO, COUNT(WorkOrdNo) QTY, READY_TIME, PROCESS_TIME
			FROM (
				SELECT WorkOrdNo,
				(SELECT Y.CONT_DTL_NO FROM TB_WORK_ORDER_ADM Y WHERE Y.WORK_ORD_NO = X.WorkOrdNo) COND_DTL_MO,
				(SELECT Y.ITEM_SEQ FROM TB_WORK_ORDER_ADM Y WHERE Y.WORK_ORD_NO = X.WorkOrdNo) ITEM_SEQ,
				(SELECT Z.READY_TIME FROM TB_WORK_ORDER_ADM Y, TB_ITEM_INFO_ADM Z WHERE Y.WORK_ORD_NO = X.WorkOrdNo AND Y.ITEM_SEQ = Z.ITEM_SEQ) READY_TIME,
				(SELECT Z.PROCESS_TIME FROM TB_WORK_ORDER_ADM Y, TB_ITEM_INFO_ADM Z WHERE Y.WORK_ORD_NO = X.WorkOrdNo AND Y.ITEM_SEQ = Z.ITEM_SEQ) PROCESS_TIME,
				(SELECT Y.EQUIP_CD FROM TB_WORK_ORDER_ADM Y WHERE Y.WORK_ORD_NO = X.WorkOrdNo) EQUIP_CD
				FROM TB_LASER_OPER_INFO X
				GROUP BY WorkOrdNo
				<if test="dateType.equals('month')">
				HAVING CONVERT(CHAR(8), MIN(REGDATE), 112) LIKE CONCAT(LEFT(#{searchDate}, 4), RIGHT(#{searchDate}, 2), '%')
				</if>
				<if test="dateType.equals('year')">
				HAVING CONVERT(CHAR(8), MIN(REGDATE), 112) LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
				</if>
			) A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
			AND B.USE_YN = '001'
			AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
			AND B.EQUIP_CD = #{equipCd}
			</if>
			GROUP BY COND_DTL_MO, READY_TIME, PROCESS_TIME, A.EQUIP_CD
		) B
	</if>
	<if test="mainGubun.equals('002')">
		SELECT ISNULL(SUM(OUTPUT_QTY), 0)
		FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
		WHERE A.EQUIP_CD = B.EQUIP_CD
			AND B.USE_YN = '001'
			AND B.PRC_NM = #{mainGubun}
		<if test="equipCd !=null and !equipCd.equals('')">
			AND B.EQUIP_CD = #{equipCd}
		</if>	
		<if test="dateType.equals('month')">
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
		</if>
		<if test="dateType.equals('year')">
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
		</if>
	</if>
	 -->
	</select>
	
	<!-- 월 기준 설비 가동률 조회 -->
	<select id="equipOperatingPercentMonthList" resultMap="EquipDataVo" parameterType="java.util.List" >
		<foreach collection="list" item="item" separator=" UNION ALL ">
		
		SELECT
		#{item.searchDate} AS SEARCH_DATE,
		(
			SELECT 
			ISNULL(CONVERT(float, SUM(RUNNING_TIME)), 0) * 60
			FROM TB_FACTORY_CALENDAR
			WHERE FACTORY_TYPE = #{item.mainGubun}
			AND FACTORY_DATE LIKE CONCAT('%', #{item.searchDate}, '%')
		) HOLD_TIME,
		<if test="item.mainGubun.equals('001')">
		(
			SELECT 
			ISNULL(SUM((
				CASE WHEN A.WORK_END_DATE IS NULL
				THEN DATEDIFF(MS, WORK_START_DATE, GETDATE())
				ELSE DATEDIFF(MS, A.WORK_START_DATE, A.WORK_END_DATE)
				END
			)), 0) / 60000
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
			AND B.PRC_NM = #{item.mainGubun}
			<if test="item.equipCd !=null and !item.equipCd.equals('')">
			AND A.EQUIP_CD = #{item.equipCd}
			</if>
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{item.searchDate}, 4), '-', SUBSTRING(#{item.searchDate}, 5, 2), '-', RIGHT(#{item.searchDate}, 2),  '%')		
		) OPERATION_TIME,
		</if>
		<if test="item.mainGubun.equals('002')">
		(
			SELECT 
			ISNULL(SUM((
				CASE WHEN A.WORK_END_DATE IS NULL
				THEN DATEDIFF(MS, WORK_START_DATE, WORK_START_DATE)
				ELSE DATEDIFF(MS, A.WORK_START_DATE, A.WORK_END_DATE)
				END
			)), 0) / 60000
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
			AND B.PRC_NM = #{item.mainGubun}
			<if test="item.equipCd !=null and !item.equipCd.equals('')">
			AND A.EQUIP_CD = #{item.equipCd}
			</if>
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{item.searchDate}, 4), '-', SUBSTRING(#{item.searchDate}, 5, 2), '-', RIGHT(#{item.searchDate}, 2),  '%')
			<!-- 
			SELECT ISNULL(SUM(A.WORK_TIME), 0) / 60000
			FROM (
				SELECT 
					(
						CASE WHEN A.STATUS = 'START'
						THEN 
						DATEDIFF(MS, A.START_DATE, (
							CASE WHEN LEAD(A.END_DATE) OVER(ORDER BY NUM) IS NOT NULL
							THEN LEAD(A.END_DATE) OVER(ORDER BY NUM)
							ELSE GETDATE()
							END
						))
						ELSE 0
						END
					) WORK_TIME,
					START_DATE,
					LEAD(A.END_DATE) OVER(ORDER BY NUM) END_DATE
			
				FROM (
					SELECT 
						(
							CASE WHEN A.FillStartSignal = 0 AND A.FillStartSignal = 0 AND A.nextFillStartSignal = 1 AND nextFillStartYn = 1
							THEN A.nextRegDate
							ELSE NULL
							END
						) START_DATE,
						(
							CASE WHEN A.FillStartSignal = 1 AND A.FillStartSignal = 1 AND A.nextFillStartSignal = 0 AND nextFillStartYn = 0
							THEN A.nextRegDate
							ELSE NULL
							END
						) END_DATE,
						(
							CASE WHEN A.FillStartSignal = 0 AND A.FillStartSignal = 0 AND A.nextFillStartSignal = 1 AND nextFillStartYn = 1
							THEN 'START'
							WHEN A.FillStartSignal = 1 AND A.FillStartSignal = 1 AND A.nextFillStartSignal = 0 AND nextFillStartYn = 0
							THEN 'END'
							ELSE NULL
							END
						) STATUS,
						ROW_NUMBER() OVER (ORDER BY (SELECT 1)) AS NUM
					FROM (
						SELECT
						A.FillStartSignal,
						A.FillStartYn,
						A.regDate,
						LEAD(A.FillStartSignal) OVER(ORDER BY (SELECT 1)) AS nextFillStartSignal,
						LEAD(A.FillStartYn) OVER(ORDER BY (SELECT 1)) AS nextFillStartYn,
						LEAD(A.RegDate) OVER(ORDER BY (SELECT 1)) AS nextRegDate
						FROM TB_PACKING_OPER_INFO A
						WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(LEFT(#{item.searchDate}, 4), SUBSTRING(#{item.searchDate}, 5, 2), RIGHT(#{item.searchDate}, 2),  '%')		
					) A
					WHERE (
							CASE WHEN A.FillStartSignal = 0 AND A.FillStartSignal = 0 AND A.nextFillStartSignal = 1 AND nextFillStartYn = 1
							THEN A.nextRegDate
							ELSE NULL
							END
						) IS NOT NULL OR (
							CASE WHEN A.FillStartSignal = 1 AND A.FillStartSignal = 1 AND A.nextFillStartSignal = 0 AND nextFillStartYn = 0
							THEN A.nextRegDate
							ELSE NULL
							END
						) IS NOT NULL
				) A
			) A
			 -->
		) OPERATION_TIME,
		</if>
		<if test="item.mainGubun.equals('001')">
		(
			SELECT
				ISNULL(SUM(
				ISNULL(ISNULL(READY_TIME, 0) + ISNULL(PROCESS_TIME, 0) *QTY, 0)
				), 0)
			FROM (
				SELECT
				COUNT(WORK_ORD_NO) QTY, READY_TIME, PROCESS_TIME
				FROM (
					SELECT 
						A.WORK_ORD_NO,
						(SELECT Y.ITEM_SEQ FROM TB_WORK_ORDER_ADM Y WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO) ITEM_SEQ,
						(SELECT Z.READY_TIME FROM TB_WORK_ORDER_ADM Y, TB_ITEM_INFO_ADM Z WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO AND Y.ITEM_SEQ = Z.ITEM_SEQ) READY_TIME,
						(SELECT Z.PROCESS_TIME FROM TB_WORK_ORDER_ADM Y, TB_ITEM_INFO_ADM Z WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO AND Y.ITEM_SEQ = Z.ITEM_SEQ) PROCESS_TIME,
						(SELECT Y.EQUIP_CD FROM TB_WORK_ORDER_ADM Y WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO) EQUIP_CD
					FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
					WHERE A.EQUIP_CD = B.EQUIP_CD
						AND B.USE_YN = '001'
						AND B.PRC_NM = '001'
						AND A.WORK_END_DATE IS NOT NULL
						<if test="item.equipCd !=null and !item.equipCd.equals('')">
						AND A.EQUIP_CD = #{item.equipCd}
						</if>
						AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{item.searchDate}, 4), '-', SUBSTRING(#{item.searchDate}, 5, 2), '-', RIGHT(#{item.searchDate}, 2),  '%')
				) A
				GROUP BY WORK_ORD_NO, READY_TIME, PROCESS_TIME
			) A
		) PROCESS_TIME
		</if>
		<if test="item.mainGubun.equals('002')">
		(
			SELECT ISNULL(SUM((C.READY_TIME * 60000) + (A.OUTPUT_QTY * PROCESS_TIME * 1000)), 0)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B, TB_ITEM_INFO_ADM C
			WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.USE_YN = '001'
				AND A.ITEM_SEQ = C.ITEM_SEQ
				AND B.PRC_NM = #{item.mainGubun}
			<if test="item.equipCd !=null and !item.equipCd.equals('')">
				AND B.EQUIP_CD = #{item.equipCd}
			</if>
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{item.searchDate}, 4), '-', RIGHT(#{item.searchDate}, 2), '%')
			<!-- 
			SELECT
				ISNULL(SUM(READY_TIME + PROCESS_TIME*(END_COUNT - START_COUNT)), 0)
			FROM (
				SELECT DISTINCT
					(SELECT TOP 1 X.FillOutputCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT,
					ISNULL((
						SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
						AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
						), (
						SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.RegDate > A.RegDate
						ORDER BY RegDate DESC
						)) END_COUNT,
					ISNULL((
						SELECT TOP 1
						Z.PROCESS_TIME
						FROM (SELECT X.ITEM_SEQ, X.EQUIP_CD
						FROM TB_WORK_ORDER_ADM X
						WHERE CONVERT(CHAR(8), X.REG_DATE, 112) = CONVERT(CHAR(8), (SELECT TOP 1 B.RegDate FROM TB_PACKING_OPER_INFO B WHERE B.FillStartSignal = 1 AND B.FillStartYn = 1 AND B.RegDate > A.RegDate), 112)
						) X, TB_EQUIP_CODE_ADM Y, TB_ITEM_INFO_ADM Z
						WHERE X.EQUIP_CD = Y.EQUIP_CD
							AND Y.PRC_NM = '002'
							AND X.ITEM_SEQ = Z.ITEM_SEQ
					), 0) / 60 AS PROCESS_TIME,
					ISNULL((
						SELECT TOP 1
						Z.READY_TIME
						FROM (SELECT X.ITEM_SEQ, X.EQUIP_CD
						FROM TB_WORK_ORDER_ADM X
						WHERE CONVERT(CHAR(8), X.REG_DATE, 112) = CONVERT(CHAR(8), (SELECT TOP 1 B.RegDate FROM TB_PACKING_OPER_INFO B WHERE B.FillStartSignal = 1 AND B.FillStartYn = 1 AND B.RegDate > A.RegDate), 112)
						) X, TB_EQUIP_CODE_ADM Y, TB_ITEM_INFO_ADM Z
						WHERE X.EQUIP_CD = Y.EQUIP_CD
							AND Y.PRC_NM = '002'
							AND X.ITEM_SEQ = Z.ITEM_SEQ
					), 0)  AS READY_TIME
				FROM TB_PACKING_OPER_INFO A
				WHERE FillStartSignal = 0 AND FillStartYn = 0
				AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(LEFT(#{item.searchDate}, 4), SUBSTRING(#{item.searchDate}, 5, 2), RIGHT(#{item.searchDate}, 2),  '%')
			) A
			 -->
		) PROCESS_TIME
		</if>
		</foreach>
	</select>
	
	<!-- 년 기준 설비 가동률 조회 -->
	<select id="equipOperatingPercentYearList" resultMap="EquipDataVo">
		<foreach collection="list" item="item" separator=" UNION ALL ">
		
		SELECT
		#{item.searchDate} AS SEARCH_DATE,
		(
			SELECT 
			ISNULL(CONVERT(float, SUM(RUNNING_TIME)), 0)
			FROM TB_FACTORY_CALENDAR
			WHERE FACTORY_TYPE = #{item.mainGubun}
			AND FACTORY_DATE LIKE CONCAT('%', #{item.searchDate}, '%')
		) HOLD_TIME,
		<if test="item.mainGubun.equals('001')">
		(
			SELECT 
			ISNULL(SUM((
				CASE WHEN A.WORK_END_DATE IS NULL
				THEN DATEDIFF(MS, WORK_START_DATE, GETDATE())
				ELSE DATEDIFF(MS, A.WORK_START_DATE, A.WORK_END_DATE)
				END
			)), 0) / 3600000
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
			AND B.PRC_NM = #{item.mainGubun}
			<if test="item.equipCd !=null and !item.equipCd.equals('')">
			AND A.EQUIP_CD = #{item.equipCd}
			</if>
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{item.searchDate}, 4), '-', SUBSTRING(#{item.searchDate}, 5, 2),  '%')
		) OPERATION_TIME,
		</if>
		<if test="item.mainGubun.equals('002')">
		(
			SELECT 
			ISNULL(SUM((
				CASE WHEN A.WORK_END_DATE IS NULL
				THEN DATEDIFF(MS, WORK_START_DATE, WORK_START_DATE)
				ELSE DATEDIFF(MS, A.WORK_START_DATE, A.WORK_END_DATE)
				END
			)), 0) / 60000
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
			AND B.PRC_NM = #{item.mainGubun}
			<if test="item.equipCd !=null and !item.equipCd.equals('')">
			AND A.EQUIP_CD = #{item.equipCd}
			</if>
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{item.searchDate}, 4), '-', SUBSTRING(#{item.searchDate}, 5, 2),  '%')
			<!-- 
			SELECT ISNULL(SUM(A.WORK_TIME), 0) / 3600000
			FROM (
				SELECT 
					(
						CASE WHEN A.STATUS = 'START'
						THEN 
						DATEDIFF(MS, A.START_DATE, (
							CASE WHEN LEAD(A.END_DATE) OVER(ORDER BY NUM) IS NOT NULL
							THEN LEAD(A.END_DATE) OVER(ORDER BY NUM)
							ELSE GETDATE()
							END
						))
						ELSE 0
						END
					) WORK_TIME,
					START_DATE,
					LEAD(A.END_DATE) OVER(ORDER BY NUM) END_DATE
			
				FROM (
					SELECT 
						(
							CASE WHEN A.FillStartSignal = 0 AND A.FillStartSignal = 0 AND A.nextFillStartSignal = 1 AND nextFillStartYn = 1
							THEN A.nextRegDate
							ELSE NULL
							END
						) START_DATE,
						(
							CASE WHEN A.FillStartSignal = 1 AND A.FillStartSignal = 1 AND A.nextFillStartSignal = 0 AND nextFillStartYn = 0
							THEN A.nextRegDate
							ELSE NULL
							END
						) END_DATE,
						(
							CASE WHEN A.FillStartSignal = 0 AND A.FillStartSignal = 0 AND A.nextFillStartSignal = 1 AND nextFillStartYn = 1
							THEN 'START'
							WHEN A.FillStartSignal = 1 AND A.FillStartSignal = 1 AND A.nextFillStartSignal = 0 AND nextFillStartYn = 0
							THEN 'END'
							ELSE NULL
							END
						) STATUS,
						ROW_NUMBER() OVER (ORDER BY (SELECT 1)) AS NUM
					FROM (
						SELECT
						A.FillStartSignal,
						A.FillStartYn,
						A.regDate,
						LEAD(A.FillStartSignal) OVER(ORDER BY (SELECT 1)) AS nextFillStartSignal,
						LEAD(A.FillStartYn) OVER(ORDER BY (SELECT 1)) AS nextFillStartYn,
						LEAD(A.RegDate) OVER(ORDER BY (SELECT 1)) AS nextRegDate
						FROM TB_PACKING_OPER_INFO A
						WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(#{item.searchDate}, '%')
					) A
					WHERE (
							CASE WHEN A.FillStartSignal = 0 AND A.FillStartSignal = 0 AND A.nextFillStartSignal = 1 AND nextFillStartYn = 1
							THEN A.nextRegDate
							ELSE NULL
							END
						) IS NOT NULL OR (
							CASE WHEN A.FillStartSignal = 1 AND A.FillStartSignal = 1 AND A.nextFillStartSignal = 0 AND nextFillStartYn = 0
							THEN A.nextRegDate
							ELSE NULL
							END
						) IS NOT NULL
				) A
			) A		
			 -->		
		) OPERATION_TIME,
		</if>
		<if test="item.mainGubun.equals('001')">
		(
			SELECT
				ISNULL(SUM(
				ISNULL(ISNULL(READY_TIME, 0) + ISNULL(PROCESS_TIME, 0) *QTY, 0) / 60
				), 0)
			FROM (
				SELECT
				COUNT(WORK_ORD_NO) QTY, READY_TIME, PROCESS_TIME
				FROM (
					SELECT 
						A.WORK_ORD_NO,
						(SELECT Y.ITEM_SEQ FROM TB_WORK_ORDER_ADM Y WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO) ITEM_SEQ,
						(SELECT Z.READY_TIME FROM TB_WORK_ORDER_ADM Y, TB_ITEM_INFO_ADM Z WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO AND Y.ITEM_SEQ = Z.ITEM_SEQ) READY_TIME,
						(SELECT Z.PROCESS_TIME FROM TB_WORK_ORDER_ADM Y, TB_ITEM_INFO_ADM Z WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO AND Y.ITEM_SEQ = Z.ITEM_SEQ) PROCESS_TIME,
						(SELECT Y.EQUIP_CD FROM TB_WORK_ORDER_ADM Y WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO) EQUIP_CD
					FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
					WHERE A.EQUIP_CD = B.EQUIP_CD
						AND B.USE_YN = '001'
						AND B.PRC_NM = '001'
						AND A.WORK_END_DATE IS NOT NULL
						<if test="item.equipCd !=null and !item.equipCd.equals('')">
						AND A.EQUIP_CD = #{item.equipCd}
						</if>
						AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{item.searchDate}, 4), '-', SUBSTRING(#{item.searchDate}, 5, 2),  '%')
				) A
				GROUP BY WORK_ORD_NO, READY_TIME, PROCESS_TIME
			) A
		) PROCESS_TIME
		</if>
		<if test="item.mainGubun.equals('002')">
		(
			SELECT ISNULL(SUM((C.READY_TIME * 60000) + (A.OUTPUT_QTY * PROCESS_TIME * 1000)), 0)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B, TB_ITEM_INFO_ADM C
			WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.USE_YN = '001'
				AND A.ITEM_SEQ = C.ITEM_SEQ
				AND B.PRC_NM = #{item.mainGubun}
			<if test="item.equipCd !=null and !item.equipCd.equals('')">
				AND B.EQUIP_CD = #{item.equipCd}
			</if>
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{item.searchDate}, 4), '-', SUBSTRING(#{item.searchDate}, 5, 2),  '%')
			<!-- 
			SELECT
				ISNULL(SUM(READY_TIME + PROCESS_TIME*(END_COUNT - START_COUNT)), 0) / 3600000
			FROM (
				SELECT DISTINCT
					(SELECT TOP 1 X.FillOutputCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT,
					ISNULL((
						SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
						AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
						), (
						SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.RegDate > A.RegDate
						ORDER BY RegDate DESC
						)) END_COUNT,
					ISNULL((
						SELECT TOP 1
						Z.PROCESS_TIME
						FROM (SELECT X.ITEM_SEQ, X.EQUIP_CD
						FROM TB_WORK_ORDER_ADM X
						WHERE CONVERT(CHAR(8), X.REG_DATE, 112) = CONVERT(CHAR(8), (SELECT TOP 1 B.RegDate FROM TB_PACKING_OPER_INFO B WHERE B.FillStartSignal = 1 AND B.FillStartYn = 1 AND B.RegDate > A.RegDate), 112)
						) X, TB_EQUIP_CODE_ADM Y, TB_ITEM_INFO_ADM Z
						WHERE X.EQUIP_CD = Y.EQUIP_CD
							AND Y.PRC_NM = '002'
							AND X.ITEM_SEQ = Z.ITEM_SEQ
					), 0) * 1000 AS PROCESS_TIME,
					ISNULL((
						SELECT TOP 1
						Z.READY_TIME
						FROM (SELECT X.ITEM_SEQ, X.EQUIP_CD
						FROM TB_WORK_ORDER_ADM X
						WHERE CONVERT(CHAR(8), X.REG_DATE, 112) = CONVERT(CHAR(8), (SELECT TOP 1 B.RegDate FROM TB_PACKING_OPER_INFO B WHERE B.FillStartSignal = 1 AND B.FillStartYn = 1 AND B.RegDate > A.RegDate), 112)
						) X, TB_EQUIP_CODE_ADM Y, TB_ITEM_INFO_ADM Z
						WHERE X.EQUIP_CD = Y.EQUIP_CD
							AND Y.PRC_NM = '002'
							AND X.ITEM_SEQ = Z.ITEM_SEQ
					), 0) * 60000 AS READY_TIME
				FROM TB_PACKING_OPER_INFO A
				WHERE FillStartSignal = 0 AND FillStartYn = 0
				AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(#{item.searchDate}, '%')
			) A
			 -->
		) PROCESS_TIME
		</if>
		</foreach>
	</select>
	
	<!-- 월 기준 생산수량, 불량수량 조회 -->
	<select id="faultyPercentYearList" resultMap="EquipDataVo">
		<foreach collection="list" item="item" separator=" UNION ALL ">
		SELECT
		(
		<if test="item.mainGubun.equals('001')">
			SELECT COUNT(*)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.USE_YN = '001'
				AND B.PRC_NM = #{item.mainGubun}
				AND A.WORK_END_DATE IS NOT NULL
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{item.searchDate}, 4), '-', RIGHT(#{item.searchDate}, 2), '%')
		</if>
		<if test="item.mainGubun.equals('002')">
			SELECT ISNULL(SUM(OUTPUT_QTY), 0)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.USE_YN = '001'
				AND B.PRC_NM = #{item.mainGubun}
				AND A.WORK_END_DATE IS NOT NULL
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{item.searchDate}, 4), '-', RIGHT(#{item.searchDate}, 2), '%')
			<!-- 
			SELECT
				ISNULL(SUM(END_COUNT - START_COUNT), 0)
			FROM (
				SELECT DISTINCT
					(SELECT TOP 1 X.FillOutputCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT,
					ISNULL((
						SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
						AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
						), (
						SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.RegDate > A.RegDate
						ORDER BY RegDate DESC
						)) END_COUNT
				FROM (
					select *,
					(LEAD(FillStartSignal) OVER(ORDER BY REGDATE)) NextFillStartSignal,
					(LEAD(FillStartYn) OVER(ORDER BY REGDATE)) NextFillStartYn
					FROM TB_PACKING_OPER_INFO
					WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(#{item.searchDate}, '%')		
				) A
				WHERE FillStartSignal = 0 AND FillStartYn = 0
				AND FillStartSignal = 0 AND FillStartYn = 0 AND NextFillStartSignal = 1 AND NextFillStartYn = 1		
			) A
			 -->
		</if>
		) PRODUCTION_QTY,
		(
		<if test="item.mainGubun.equals('001')">
			SELECT ISNULL(SUM(FAULTY_QTY), 0)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
			AND B.PRC_NM = #{item.mainGubun}
			AND B.USE_YN = '001'
			AND A.WORK_END_DATE IS NOT NULL
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{item.searchDate}, 4), '-', RIGHT(#{item.searchDate}, 2), '%')		
		</if>
		<if test="item.mainGubun.equals('002')">
			SELECT ISNULL(SUM(FAULTY_QTY), 0)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
			WHERE A.EQUIP_CD = B.EQUIP_CD
			AND B.USE_YN = '001'
			AND B.PRC_NM = #{item.mainGubun}
			AND A.WORK_END_DATE IS NOT NULL
			AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{item.searchDate}, 4), '-', RIGHT(#{item.searchDate}, 2), '%')
			<!-- 
			SELECT
				ISNULL(SUM((END_COUNT1+END_COUNT2+END_COUNT3) - (START_COUNT1+START_COUNT2+START_COUNT3)), 0)
			FROM (
				SELECT DISTINCT
					(SELECT TOP 1 X.WchkUnderCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT1,
					ISNULL((
						SELECT TOP 1 Y.WchkUnderCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
						AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
						), (
						SELECT TOP 1 Y.WchkUnderCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.RegDate > A.RegDate
						ORDER BY RegDate DESC
						)) END_COUNT1,
					(SELECT TOP 1 X.WchkOverCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT2,
					ISNULL((
						SELECT TOP 1 Y.WchkOverCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
						AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
						), (
						SELECT TOP 1 Y.WchkOverCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.RegDate > A.RegDate
						ORDER BY RegDate DESC
						)) END_COUNT2,
					(SELECT TOP 1 X.WchkExNgCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT3,
					ISNULL((
						SELECT TOP 1 Y.WchkExNgCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
						AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
						), (
						SELECT TOP 1 Y.WchkExNgCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.RegDate > A.RegDate
						ORDER BY RegDate DESC
						)) END_COUNT3
				FROM (
					select *,
					(LEAD(FillStartSignal) OVER(ORDER BY REGDATE)) NextFillStartSignal,
					(LEAD(FillStartYn) OVER(ORDER BY REGDATE)) NextFillStartYn
					FROM TB_PACKING_OPER_INFO
					WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(#{item.searchDate}, '%')		
				) A
				WHERE FillStartSignal = 0 AND FillStartYn = 0
				AND FillStartSignal = 0 AND FillStartYn = 0 AND NextFillStartSignal = 1 AND NextFillStartYn = 1
			) A
			 -->
		</if>
		) FAULTY_QTY
		</foreach>
	</select>
	
	<!-- 년도 기준 불량타입별 불량 수량 조회 -->
	<select id="faultyTypeYearList" resultMap="EquipDataVo">
			SELECT E.BASE_INFO_CD AS FAULTY_CD, E.BASE_INFO_NM AS FAULTY_NM,
			(
			SELECT ISNULL(SUM(ISNULL(C.FAULTY_TYPE_QTY, 0) *  ISNULL(D.FILLING_COUNT, 1)), 0)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B, TB_WORK_ORDER_FAULTY_TYPE C, TB_ITEM_INFO_ADM D
			WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.USE_YN = '001'
				AND C.FAULTY_TYPE_CD = E.BASE_INFO_CD
				AND B.PRC_NM = #{mainGubun}
				AND A.WORK_ORD_NO = C.WORK_ORD_NO
				AND A.ITEM_SEQ = D.ITEM_SEQ
			AND A.WORK_START_DATE LIKE CONCAT(#{searchDate}, '%')
			) FAULTY_QTY
			FROM TB_BASE_INFO_ADM E
			WHERE E.BASE_INFO_TYPE = 'FT'
			AND E.ETC1 = #{mainGubun}
			ORDER BY FAULTY_QTY DESC
		<!-- 	
		<if test="mainGubun.equals('002')">
			SELECT
				'001' AS FAULTY_CD,
				'경량' AS FAULTY_NM,
				ISNULL(SUM(END_COUNT - START_COUNT), 0) AS FAULTY_QTY
			FROM (
				SELECT DISTINCT
					(SELECT TOP 1 X.WchkUnderCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT,
					ISNULL((
						SELECT TOP 1 Y.WchkUnderCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
						AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
						), (
						SELECT TOP 1 Y.WchkUnderCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.RegDate > A.RegDate
						ORDER BY RegDate DESC
						)) END_COUNT
				FROM (
					select *,
					(LEAD(FillStartSignal) OVER(ORDER BY REGDATE)) NextFillStartSignal,
					(LEAD(FillStartYn) OVER(ORDER BY REGDATE)) NextFillStartYn
					FROM TB_PACKING_OPER_INFO
					WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(#{searchDate}, '%')		
				) A
				WHERE FillStartSignal = 0 AND FillStartYn = 0
				AND FillStartSignal = 0 AND FillStartYn = 0 AND NextFillStartSignal = 1 AND NextFillStartYn = 1	
			) A
			
			UNION ALL
			
			SELECT
				'002' AS FAULTY_CD,
				'과량' AS FAULTY_NM,
				ISNULL(SUM(END_COUNT - START_COUNT), 0) AS FAULTY_QTY
			FROM (
				SELECT DISTINCT
					(SELECT TOP 1 X.WchkOverCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT,
					ISNULL((
						SELECT TOP 1 Y.WchkOverCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
						AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
						), (
						SELECT TOP 1 Y.WchkOverCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.RegDate > A.RegDate
						ORDER BY RegDate DESC
						)) END_COUNT
				FROM (
					select *,
					(LEAD(FillStartSignal) OVER(ORDER BY REGDATE)) NextFillStartSignal,
					(LEAD(FillStartYn) OVER(ORDER BY REGDATE)) NextFillStartYn
					FROM TB_PACKING_OPER_INFO
					WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(#{searchDate}, '%')		
				) A
				WHERE FillStartSignal = 0 AND FillStartYn = 0
				AND FillStartSignal = 0 AND FillStartYn = 0 AND NextFillStartSignal = 1 AND NextFillStartYn = 1
			) A
			
			UNION ALL
			
			SELECT
				'003' AS FAULTY_CD,
				'금속검출 및 이중진입' AS FAULTY_NM,
				ISNULL(SUM(END_COUNT - START_COUNT), 0) AS FAULTY_QTY
			FROM (
				SELECT DISTINCT
					(SELECT TOP 1 X.WchkExNgCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT,
					ISNULL((
						SELECT TOP 1 Y.WchkExNgCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
						AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
						), (
						SELECT TOP 1 Y.WchkExNgCount FROM TB_PACKING_OPER_INFO Y 
						WHERE Y.RegDate > A.RegDate
						ORDER BY RegDate DESC
						)) END_COUNT
				FROM (
					select *,
					(LEAD(FillStartSignal) OVER(ORDER BY REGDATE)) NextFillStartSignal,
					(LEAD(FillStartYn) OVER(ORDER BY REGDATE)) NextFillStartYn
					FROM TB_PACKING_OPER_INFO
					WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(#{searchDate}, '%')		
				) A
				WHERE FillStartSignal = 0 AND FillStartYn = 0
				AND FillStartSignal = 0 AND FillStartYn = 0 AND NextFillStartSignal = 1 AND NextFillStartYn = 1
			) A
		</if>
		 -->
	</select>
	
	<!-- 설비종합효율 테이블 리스트(설비별 부하시간, 가동시간, 이론CT, 생산량, 투입수량, 불량수량) 조회-->
	<select id="equipTotalDataList" resultMap="EquipDataVo">
		SELECT EQUIP_CD, EQUIP_NM,
		(
			SELECT 
				ISNULL(CONVERT(float, SUM(RUNNING_TIME)), 0) * 3600000
			FROM TB_FACTORY_CALENDAR
			WHERE FACTORY_TYPE = #{mainGubun}
			<if test="dateType.equals('month')">
			AND FACTORY_DATE LIKE CONCAT('%', #{searchDate}, '%')
			</if>
			<if test="dateType.equals('year')">
			AND FACTORY_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
			</if>
		) LOAD_TIME,
		(
			<if test="mainGubun.equals('001')">
				SELECT 
				ISNULL(SUM((
					CASE WHEN A.WORK_END_DATE IS NULL
					THEN DATEDIFF(MS, WORK_START_DATE, GETDATE())
					ELSE DATEDIFF(MS, A.WORK_START_DATE, A.WORK_END_DATE)
					END
				)), 0) 
				FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
				WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.PRC_NM = #{mainGubun}
				<if test="equipCd !=null and !equipCd.equals('')">
				AND A.EQUIP_CD = #{equipCd}
				</if>
				<if test="dateType.equals('month')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
				</if>
				<if test="dateType.equals('year')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
				</if>
			</if>
			<if test="mainGubun.equals('002')">
				SELECT 
				ISNULL(SUM((
					CASE WHEN A.WORK_END_DATE IS NULL
					THEN DATEDIFF(MS, WORK_START_DATE, WORK_END_DATE)
					ELSE DATEDIFF(MS, A.WORK_START_DATE, A.WORK_END_DATE)
					END
				)), 0) 
				FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
				WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.PRC_NM = #{mainGubun}
				<if test="equipCd !=null and !equipCd.equals('')">
				AND A.EQUIP_CD = #{equipCd}
				</if>
				<if test="dateType.equals('month')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
				</if>
				<if test="dateType.equals('year')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
				</if>
			</if>
		<!-- 
		<if test="mainGubun.equals('002')">
			SELECT ISNULL(SUM(A.WORK_TIME), 0)
			FROM (
				SELECT 
					(
						CASE WHEN A.STATUS = 'START'
						THEN 
						DATEDIFF(MS, A.START_DATE, (
							CASE WHEN LEAD(A.END_DATE) OVER(ORDER BY NUM) IS NOT NULL
							THEN LEAD(A.END_DATE) OVER(ORDER BY NUM)
							ELSE GETDATE()
							END
						))
						ELSE 0
						END
					) WORK_TIME,
					START_DATE,
					LEAD(A.END_DATE) OVER(ORDER BY NUM) END_DATE
			
				FROM (
					SELECT 
						(
							CASE WHEN A.FillStartSignal = 0 AND A.FillStartSignal = 0 AND A.nextFillStartSignal = 1 AND nextFillStartYn = 1
							THEN A.nextRegDate
							ELSE NULL
							END
						) START_DATE,
						(
							CASE WHEN A.FillStartSignal = 1 AND A.FillStartSignal = 1 AND A.nextFillStartSignal = 0 AND nextFillStartYn = 0
							THEN A.nextRegDate
							ELSE NULL
							END
						) END_DATE,
						(
							CASE WHEN A.FillStartSignal = 0 AND A.FillStartSignal = 0 AND A.nextFillStartSignal = 1 AND nextFillStartYn = 1
							THEN 'START'
							WHEN A.FillStartSignal = 1 AND A.FillStartSignal = 1 AND A.nextFillStartSignal = 0 AND nextFillStartYn = 0
							THEN 'END'
							ELSE NULL
							END
						) STATUS,
						ROW_NUMBER() OVER (ORDER BY (SELECT 1)) AS NUM
					FROM (
						SELECT
						A.FillStartSignal,
						A.FillStartYn,
						A.regDate,
						LEAD(A.FillStartSignal) OVER(ORDER BY (SELECT 1)) AS nextFillStartSignal,
						LEAD(A.FillStartYn) OVER(ORDER BY (SELECT 1)) AS nextFillStartYn,
						LEAD(A.RegDate) OVER(ORDER BY (SELECT 1)) AS nextRegDate
						FROM TB_PACKING_OPER_INFO A
						<if test="dateType.equals('month')">
						WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(#{searchDate}, '%')		
						</if>
						<if test="dateType.equals('year')">
						WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
						</if>
					) A
					WHERE (
							CASE WHEN A.FillStartSignal = 0 AND A.FillStartSignal = 0 AND A.nextFillStartSignal = 1 AND nextFillStartYn = 1
							THEN A.nextRegDate
							ELSE NULL
							END
						) IS NOT NULL OR (
							CASE WHEN A.FillStartSignal = 1 AND A.FillStartSignal = 1 AND A.nextFillStartSignal = 0 AND nextFillStartYn = 0
							THEN A.nextRegDate
							ELSE NULL
							END
						) IS NOT NULL
				) A
			) A
		</if>
		 -->
		) PROCESS_TIME,
		(
		<if test="mainGubun.equals('001')">
			SELECT
				ISNULL(SUM(
				ISNULL(ISNULL(READY_TIME, 0) + ISNULL(PROCESS_TIME, 0) *QTY, 0) * 60000
				), 0)
			FROM (
				SELECT
				COUNT(WORK_ORD_NO) QTY, READY_TIME, PROCESS_TIME
				FROM (
					SELECT 
						A.WORK_ORD_NO,
						(SELECT Y.ITEM_SEQ FROM TB_WORK_ORDER_ADM Y WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO) ITEM_SEQ,
						(SELECT Z.READY_TIME FROM TB_WORK_ORDER_ADM Y, TB_ITEM_INFO_ADM Z WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO AND Y.ITEM_SEQ = Z.ITEM_SEQ) READY_TIME,
						(SELECT Z.PROCESS_TIME FROM TB_WORK_ORDER_ADM Y, TB_ITEM_INFO_ADM Z WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO AND Y.ITEM_SEQ = Z.ITEM_SEQ) PROCESS_TIME,
						(SELECT Y.EQUIP_CD FROM TB_WORK_ORDER_ADM Y WHERE Y.WORK_ORD_NO = A.WORK_ORD_NO) EQUIP_CD
					FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
					WHERE A.EQUIP_CD = B.EQUIP_CD
						AND B.USE_YN = '001'
						AND B.PRC_NM = '001'
						AND A.WORK_END_DATE IS NOT NULL
						<if test="dateType.equals('month')">
						AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
						</if>
						<if test="dateType.equals('year')">
						AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
						</if>
				) A
				GROUP BY WORK_ORD_NO, READY_TIME, PROCESS_TIME
			) A
		</if>
		<if test="mainGubun.equals('002')">
			SELECT ISNULL(SUM((C.READY_TIME * 60000) + (A.OUTPUT_QTY * PROCESS_TIME * 1000)), 0)
			FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B, TB_ITEM_INFO_ADM C
			WHERE A.EQUIP_CD = B.EQUIP_CD
				AND B.USE_YN = '001'
				AND A.ITEM_SEQ = C.ITEM_SEQ
				AND B.PRC_NM = #{mainGubun}
			<if test="equipCd !=null and !equipCd.equals('')">
				AND B.EQUIP_CD = #{equipCd}
			</if>
			<if test="dateType.equals('month')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
			</if>
			<if test="dateType.equals('year')">
				AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
			</if>
			<!-- 
			SELECT
			(
				SELECT TOP 1 X.FillOutputCount
				FROM TB_PACKING_OPER_INFO X
				<if test="dateType.equals('month')">
				WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(#{searchDate}, '%')		
				</if>
				<if test="dateType.equals('year')">
				WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
				</if>
				ORDER BY RegDate DESC
			) - (
				SELECT TOP 1 X.FillOutputCount
				FROM TB_PACKING_OPER_INFO X
				<if test="dateType.equals('month')">
				WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(#{searchDate}, '%')		
				</if>
				<if test="dateType.equals('year')">
				WHERE CONVERT(CHAR(8), REGDATE, 112) LIKE CONCAT(LEFT(#{searchDate}, 4), '%')		
				</if>
				ORDER BY RegDate
			)
			 -->
		</if>
		) THEORY_CT,
		(
			<if test="mainGubun.equals('001')">
				SELECT COUNT(*)
				FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
				WHERE A.EQUIP_CD = B.EQUIP_CD
					AND B.USE_YN = '001'
					AND B.PRC_NM = #{mainGubun}
					AND A.WORK_END_DATE IS NOT NULL
				<if test="equipCd !=null and !equipCd.equals('')">
					AND B.EQUIP_CD = #{equipCd}
				</if>	
				<if test="dateType.equals('month')">
					AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
				</if>
				<if test="dateType.equals('year')">
					AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
				</if>
			</if>
			<if test="mainGubun.equals('002')">
				SELECT ISNULL(SUM(OUTPUT_QTY), 0)
				FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
				WHERE A.EQUIP_CD = B.EQUIP_CD
					AND B.USE_YN = '001'
					AND B.PRC_NM = #{mainGubun}
				<if test="equipCd !=null and !equipCd.equals('')">
					AND B.EQUIP_CD = #{equipCd}
				</if>	
				<if test="dateType.equals('month')">
					AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
				</if>
				<if test="dateType.equals('year')">
					AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
				</if>
			<!-- 
				SELECT
					ISNULL(SUM(END_COUNT - START_COUNT), 0)
				FROM (
					SELECT DISTINCT
						(SELECT TOP 1 X.FillOutputCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT,
						ISNULL((
							SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
							WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
							AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
							), (
							SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
							WHERE Y.RegDate > A.RegDate
							ORDER BY RegDate DESC
							)) END_COUNT,
						ISNULL((
							SELECT TOP 1
							Z.PROCESS_TIME
							FROM (SELECT X.ITEM_SEQ, X.EQUIP_CD
							FROM TB_WORK_ORDER_ADM X
							WHERE CONVERT(CHAR(8), X.REG_DATE, 112) = CONVERT(CHAR(8), (SELECT TOP 1 B.RegDate FROM TB_PACKING_OPER_INFO B WHERE B.FillStartSignal = 1 AND B.FillStartYn = 1 AND B.RegDate > A.RegDate), 112)
							) X, TB_EQUIP_CODE_ADM Y, TB_ITEM_INFO_ADM Z
							WHERE X.EQUIP_CD = Y.EQUIP_CD
								AND Y.PRC_NM = '002'
								AND X.ITEM_SEQ = Z.ITEM_SEQ
						), 0) * 1000 AS PROCESS_TIME,
						ISNULL((
							SELECT TOP 1
							Z.READY_TIME
							FROM (SELECT X.ITEM_SEQ, X.EQUIP_CD
							FROM TB_WORK_ORDER_ADM X
							WHERE CONVERT(CHAR(8), X.REG_DATE, 112) = CONVERT(CHAR(8), (SELECT TOP 1 B.RegDate FROM TB_PACKING_OPER_INFO B WHERE B.FillStartSignal = 1 AND B.FillStartYn = 1 AND B.RegDate > A.RegDate), 112)
							) X, TB_EQUIP_CODE_ADM Y, TB_ITEM_INFO_ADM Z
							WHERE X.EQUIP_CD = Y.EQUIP_CD
								AND Y.PRC_NM = '002'
								AND X.ITEM_SEQ = Z.ITEM_SEQ
						), 0) * 60000 AS READY_TIME
					FROM TB_PACKING_OPER_INFO A
					WHERE FillStartSignal = 0 AND FillStartYn = 0
					<if test="dateType.equals('month')">
					AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(#{searchDate}, '%')		
					</if>
					<if test="dateType.equals('year')">
					AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
					</if>
				) A
			-->
			</if>
		) PRODUCTION_QTY,
		(
			<if test="mainGubun.equals('001')">
				SELECT COUNT(*)
				FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
				WHERE A.EQUIP_CD = B.EQUIP_CD
					AND B.USE_YN = '001'
					AND B.PRC_NM = #{mainGubun}
					AND A.WORK_END_DATE IS NOT NULL
				<if test="equipCd !=null and !equipCd.equals('')">
					AND B.EQUIP_CD = #{equipCd}
				</if>	
				<if test="dateType.equals('month')">
					AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
				</if>
				<if test="dateType.equals('year')">
					AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
				</if>
			</if>
			<if test="mainGubun.equals('002')">
				SELECT ISNULL(SUM(OUTPUT_QTY), 0)
				FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
				WHERE A.EQUIP_CD = B.EQUIP_CD
					AND B.USE_YN = '001'
					AND B.PRC_NM = #{mainGubun}
				<if test="equipCd !=null and !equipCd.equals('')">
					AND B.EQUIP_CD = #{equipCd}
				</if>	
				<if test="dateType.equals('month')">
					AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
				</if>
				<if test="dateType.equals('year')">
					AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
				</if>
				<!-- 
				SELECT
					ISNULL(SUM(END_COUNT - START_COUNT), 0)
				FROM (
					SELECT DISTINCT
						(SELECT TOP 1 X.FillOutputCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT,
						ISNULL((
							SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
							WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
							AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
							), (
							SELECT TOP 1 Y.FillOutputCount FROM TB_PACKING_OPER_INFO Y 
							WHERE Y.RegDate > A.RegDate
							ORDER BY RegDate DESC
							)) END_COUNT,
						ISNULL((
							SELECT TOP 1
							Z.PROCESS_TIME
							FROM (SELECT X.ITEM_SEQ, X.EQUIP_CD
							FROM TB_WORK_ORDER_ADM X
							WHERE CONVERT(CHAR(8), X.REG_DATE, 112) = CONVERT(CHAR(8), (SELECT TOP 1 B.RegDate FROM TB_PACKING_OPER_INFO B WHERE B.FillStartSignal = 1 AND B.FillStartYn = 1 AND B.RegDate > A.RegDate), 112)
							) X, TB_EQUIP_CODE_ADM Y, TB_ITEM_INFO_ADM Z
							WHERE X.EQUIP_CD = Y.EQUIP_CD
								AND Y.PRC_NM = '002'
								AND X.ITEM_SEQ = Z.ITEM_SEQ
						), 0) * 1000 AS PROCESS_TIME,
						ISNULL((
							SELECT TOP 1
							Z.READY_TIME
							FROM (SELECT X.ITEM_SEQ, X.EQUIP_CD
							FROM TB_WORK_ORDER_ADM X
							WHERE CONVERT(CHAR(8), X.REG_DATE, 112) = CONVERT(CHAR(8), (SELECT TOP 1 B.RegDate FROM TB_PACKING_OPER_INFO B WHERE B.FillStartSignal = 1 AND B.FillStartYn = 1 AND B.RegDate > A.RegDate), 112)
							) X, TB_EQUIP_CODE_ADM Y, TB_ITEM_INFO_ADM Z
							WHERE X.EQUIP_CD = Y.EQUIP_CD
								AND Y.PRC_NM = '002'
								AND X.ITEM_SEQ = Z.ITEM_SEQ
						), 0) * 60000 AS READY_TIME
					FROM TB_PACKING_OPER_INFO A
					WHERE FillStartSignal = 0 AND FillStartYn = 0
					<if test="dateType.equals('month')">
					AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(#{searchDate}, '%')		
					</if>
					<if test="dateType.equals('year')">
					AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
					</if>
				) A
				 -->
			</if>
		) INPUT_QTY,
		(
			<if test="mainGubun.equals('001')">
				SELECT ISNULL(SUM(FAULTY_QTY), 0)
				FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
				WHERE A.EQUIP_CD = B.EQUIP_CD
					AND B.USE_YN = '001'
					AND B.PRC_NM = #{mainGubun}
					AND B.EQUIP_CD = E.EQUIP_CD
				<if test="dateType.equals('month')">
					AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
				</if>
				<if test="dateType.equals('year')">
					AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
				</if>
			</if>
			<if test="mainGubun.equals('002')">
				SELECT ISNULL(SUM(FAULTY_QTY), 0)
				FROM TB_WORK_ORDER_ADM A, TB_EQUIP_CODE_ADM B
				WHERE A.EQUIP_CD = B.EQUIP_CD
					AND B.USE_YN = '001'
					AND B.PRC_NM = #{mainGubun}
				<if test="equipCd !=null and !equipCd.equals('')">
					AND B.EQUIP_CD = #{equipCd}
				</if>	
				<if test="dateType.equals('month')">
					AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '-', RIGHT(#{searchDate}, 2), '%')
				</if>
				<if test="dateType.equals('year')">
					AND A.WORK_START_DATE LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
				</if>
				<!-- 
				SELECT
					ISNULL(SUM((END_COUNT1+END_COUNT2+END_COUNT3) - (START_COUNT1+START_COUNT2+START_COUNT3)), 0)
				FROM (
					SELECT DISTINCT
						(SELECT TOP 1 X.WchkUnderCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT1,
						ISNULL((
							SELECT TOP 1 Y.WchkUnderCount FROM TB_PACKING_OPER_INFO Y 
							WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
							AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
							), (
							SELECT TOP 1 Y.WchkUnderCount FROM TB_PACKING_OPER_INFO Y 
							WHERE Y.RegDate > A.RegDate
							ORDER BY RegDate DESC
							)) END_COUNT1,
						(SELECT TOP 1 X.WchkOverCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT2,
						ISNULL((
							SELECT TOP 1 Y.WchkOverCount FROM TB_PACKING_OPER_INFO Y 
							WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
							AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
							), (
							SELECT TOP 1 Y.WchkOverCount FROM TB_PACKING_OPER_INFO Y 
							WHERE Y.RegDate > A.RegDate
							ORDER BY RegDate DESC
							)) END_COUNT2,
						(SELECT TOP 1 X.WchkExNgCount FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate) AS START_COUNT3,
						ISNULL((
							SELECT TOP 1 Y.WchkExNgCount FROM TB_PACKING_OPER_INFO Y 
							WHERE Y.FillStartSignal = 0 AND FillStartYn = 0
							AND Y.RegDate > (SELECT TOP 1 X.REGDATE FROM TB_PACKING_OPER_INFO X WHERE X.FillStartSignal = 1 AND X.FillStartYn = 1 AND X.RegDate > A.RegDate)
							), (
							SELECT TOP 1 Y.WchkExNgCount FROM TB_PACKING_OPER_INFO Y 
							WHERE Y.RegDate > A.RegDate
							ORDER BY RegDate DESC
							)) END_COUNT3
					FROM TB_PACKING_OPER_INFO A
					WHERE FillStartSignal = 0 AND FillStartYn = 0
				<if test="dateType.equals('month')">
					AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(#{searchDate}, '%')
				</if>
				<if test="dateType.equals('year')">
					AND CONVERT(CHAR(8), A.REGDATE, 112) LIKE CONCAT(LEFT(#{searchDate}, 4), '%')
				</if>
				) A
				 -->
			</if>
		) FAULTY_QTY
		FROM TB_EQUIP_CODE_ADM E
		WHERE PRC_NM = #{mainGubun}
		AND USE_YN = '001'
		AND MAIN_GUBUN = '001'
	</select>
</mapper>
